---
layout: default
permalink: /
---

<main>
	<br><br>
	<div id="info" style="text-align: center;">
		<h1>Bugiver</h1>
		<p>
			Bugiver is a simple website that iterates through everyone that you are following and selects a random issue in a completely random
			repository in a language of your choice. I have designed it as my personal "I have nothing to do" button that gives me something
			to do in an attempt to encourage myself to contribute to more repositories than I create. Its source code, which you can find on
			<a href="/redirects/?t=github&d=bugiver">GitHub</a>, is published under the Apache 2.0 License.
		</p>
		<p>To start bug hunting, sign into your GitHub account below to give this website access to your account.</p>
		<button onclick="location.href='https://github.com/login/oauth/authorize?client_id={{ site.client_id }}';">Sign In</button>
	</div>
	<div id="option" style="display: none;">
		<h1>Options</h1>
		<br>
		<collapse>
			<h4>Languages: <span id="selectedLanguages">All</span></h4>
			<div id="languages" class="grid" style="margin-left: -24px;"></div>
			<br>
		</collapse>
		<collapse>
			<h4>Labels: <span id="selectedLabels">All</span></h4>
			<div id="labels" class="grid" style="margin-left: -24px;"></div>
			<br>
		</collapse>
		<br>
		<button onclick="randomIssue();">Done</button>
	</div>
	<div id="issue" style="display: none;">
		
		<button onclick="randomIssue();">Next Bug</button>
	</div>
	<br><br>
</main>

<script type="text/javascript" src="https://jfenn.me/js/utils.js"></script>
<script type="text/javascript">
	const _github = {
		languages: {},
		labels: {},
		issues: {}
	};

	const _infoElement = document.getElementById("info");
	
	const _optionElement = document.getElementById("option");
	const _languagesElement = document.getElementById("languages");
	const _selectedLanguagesElement = document.getElementById("selectedLanguages");
	const _labelsElement = document.getElementById("labels");
	const _selectedLabelsElement = document.getElementById("selectedLabels"); 
	
	const _issueElement = document.getElementById("issue");

	let args = UrlUtil.getCurrentArguments();
	const _token = args.token || !localStorage ? args.token : localStorage.getItem("{{ site.storage_id }}/access_token");

	var _selectedLangs = localStorage ? JSON.parse(localStorage.getItem("{{ site.storage_id }}/pref_langs")) : {};
	_selectedLangs = _selectedLangs ? _selectedLangs : {};

	var _selectedLabels = localStorage ? JSON.parse(localStorage.getItem("{{ site.storage_id }}/pref_labels")) : {};
	_selectedLabels = _selectedLabels ? _selectedLabels : {};

	if (_token) dispConfigureIssue();

	function dispConfigureIssue() {
		_infoElement.style.display = "none";
		_issueElement.style.display = "none";
		
		if (args.repo && args.issue)
			dispLoadIssue(args.repo, args.issue);
		else {
			_optionElement.style.display = null;

			if (Object.keys(_github.issues).length > 0) {
				_selectedLanguagesElement.innerText = "All";
				ElementUtil.clearElement(_languagesElement);
				
				for (let lang in _github.languages) {
					_languagesElement.append(ElementUtil.createElement("<checkbox class=\"item\"><input id=\"language" + lang + "\" name=\"" + lang
							+ "\" type=\"checkbox\"><label id=\"languageLabel" + lang + "\" for=\"language" + lang + "\"></label><span>" + lang + "</span></checkbox>"));
					
					let checkbox = document.getElementById("language" + lang);
					checkbox.checked = _selectedLangs[lang];
					checkbox.addEventListener("click", function() {
						if (this.checked)
							_selectedLangs[this.getAttribute("name")] = true;
						else delete _selectedLangs[this.getAttribute("name")];

						let text = Object.keys(_selectedLangs).join(", ");
						if (text.length > 0)
							_selectedLanguagesElement.innerText = text;		
						else _selectedLanguagesElement.innerText = "All";

						if (localStorage)
							localStorage.setItem("{{ site.storage_id }}/pref_langs", JSON.stringify(_selectedLangs));
					});

					onElement(document.getElementById("languageLabel" + lang));
				}

				let text = Object.keys(_selectedLangs).join(", ");
				if (text.length > 0)
					_selectedLanguagesElement.innerText = text;		
				else _selectedLanguagesElement.innerText = "All";

				_selectedLabelsElement.innerText = "All";
				ElementUtil.clearElement(_labelsElement);
				
				for (let name in _github.labels) {
					_labelsElement.append(ElementUtil.createElement("<checkbox class=\"item\"><input id=\"label" + name + "\" name=\"" + name
							+ "\" type=\"checkbox\"><label id=\"labelLabel" + name + "\" for=\"label" + name + "\"></label><span>" + name + "</span></checkbox>"));
					
					let checkbox = document.getElementById("label" + name);
					checkbox.checked = _selectedLabels[name];
					checkbox.addEventListener("click", function() {
						if (this.checked)
							_selectedLabels[this.getAttribute("name")] = true;
						else delete _selectedLabels[this.getAttribute("name")];

						let text = Object.keys(_selectedLabels).join(", ");
						if (text.length > 0)
							_selectedLabelsElement.innerText = text;		
						else _selectedLabelsElement.innerText = "All";

						if (localStorage)
							localStorage.setItem("{{ site.storage_id }}/pref_labels", JSON.stringify(_selectedLabels));
					});

					onElement(document.getElementById("labelLabel" + name));
				}

				text = Object.keys(_selectedLabels).join(", ");
				if (text.length > 0)
					_selectedLabelsElement.innerText = text;		
				else _selectedLabelsElement.innerText = "All";
			} else {
				fetchStuff(function() { dispConfigureIssue(); });
			}
		}
	}

	function dispRandomIssue() {
		_infoElement.style.display = "none";
		_optionElement.style.display = "none";
		_issueElement.style.display = "none";
	}

	function dispIssue(repo, issue) {
		_infoElement.style.display = "none";
		_optionElement.style.display = "none";
		_issueElement.style.display = "none";
	}

	function fetchStuff(func) {
		for (let what in _github.following) {
			if (func)
				func();
			
			return;
		}
	
		const req = new XMLHttpRequest();
		req.onreadystatechange = function() {
			if (req.readyState === 4 && (req.status === 200 || req.status == 0)) {
				let obj = JSON.parse(req.responseText);
				for (let i = 0; i < obj.data.viewer.following.nodes.length; i++) {
					for (let i2 = 0; i2 < obj.data.viewer.following.nodes[i].repositories.nodes.length; i2++) {
						for (let i3 = 0; i3 < obj.data.viewer.following.nodes[i].repositories.nodes[i2].languages.nodes.length; i3++) {
							_github.languages[obj.data.viewer.following.nodes[i].repositories.nodes[i2].languages.nodes[i3].name] = true;
						}

						for (let i3 = 0; i3 < obj.data.viewer.following.nodes[i].repositories.nodes[i2].issues.nodes.length; i3++) {
							for (let i4 = 0; i4 < obj.data.viewer.following.nodes[i].repositories.nodes[i2].issues.nodes[i3].labels.nodes.length; i4++) {
								_github.labels[StringUtil.titleize(obj.data.viewer.following.nodes[i].repositories.nodes[i2].issues.nodes[i3].labels.nodes[i4].name)] = true;
							}
						
							_github.issues[
								obj.data.viewer.following.nodes[i].repositories.nodes[i2].nameWithOwner + "issues/"
								+ obj.data.viewer.following.nodes[i].repositories.nodes[i2].issues.nodes[i3].number
							] = true;
						}
					}
				}

				if (func)
					func();
			}
		};
		req.open("POST", "https://api.github.com/graphql", true);
		if (_token)
			req.setRequestHeader("Authorization", "bearer " + _token);
		
		req.send("{\"query\": \"query { viewer { following(first: 30) { nodes { repositories(isFork: false, first: 20) { nodes { nameWithOwner, languages(first: 3) {  nodes { name } }, issues(states: [OPEN], first: 20) { nodes { number, labels(first: 2) { nodes { name } } } } } } } } } }\"}");
	}
</script>
